<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="jp.co.lyc.cms.mapper.SendRepotMapper">
    <resultMap id="SendRepot" type="jp.co.lyc.cms.model.SendRepotModel"/>
        <select id="getCustomerDepartmentCode" resultType="jp.co.lyc.cms.model.SendRepotModel">
   		SELECT 
	   		T009.customerDepartmentCode as code,
			M018.customerDepartmentName as name
		FROM
		    T009CustomerDepartmentInfo T009
		LEFT JOIN 
			M018CustomerDepartment M018
		ON
			M018.customerDepartmentCode=T009.customerDepartmentCode
		WHERE
		    T009.customerNo = #{customerNo}
		GROUP BY
			T009.customerDepartmentCode;
    </select>
    <select id="getPurchasingManagersCode" resultType="jp.co.lyc.cms.model.SendRepotModel">
  SELECT 
	  (@rowNo:=@rowNo+1 ) AS code,
	  T01.responsiblePerson AS name 
   FROM(
   		SELECT 
			responsiblePerson
		FROM
		    T009CustomerDepartmentInfo
		WHERE
			 customerNo = #{customerNo}
		AND
		    customerDepartmentCode = #{customerDepartmentCode}
	    UNION
		SELECT 
			purchasingManagers
		FROM
			T007CustomerInfo 
		WHERE 
			customerNo = #{customerNo}
		AND
			customerDepartmentCode=#{customerDepartmentCode}) T01,
			(SELECT @rowNo:=0) AS rowId
    </select>
    <!--　お客様取る -->
    <select id="getSalesCustomers" resultType="jp.co.lyc.cms.model.SendRepotModel">
	SELECT * FROM(
		SELECT 
			customerNo,
			customerName,
			purchasingManagersMail,
			purchasingManagers,
			"" as customerDepartment,
			customerDepartmentCode,
			"0" as positionCode,
			representative as responsiblePerson 
		FROM 
			rams.T007CustomerInfo
		where 
			representative!=""
	UNION
		SELECT 
			T007.customerNo,
			T007.customerName,
			T007.purchasingManagersMail,
			T007.purchasingManagers,
			T007.customerDepartment,
			T007.customerDepartmentCode,
			T007.positionCode,
			T009.responsiblePerson 
		FROM
			(SELECT 
				customerNo,
				customerName,
				purchasingManagersMail,
				purchasingManagers,
				"購買部" as customerDepartment,
				customerDepartmentCode,
				positionCode
			FROM 
				T007CustomerInfo 
			WHERE
				purchasingManagers!="" 
			AND
				customerDepartmentCode=3)T007
			LEFT JOIN 
				T009CustomerDepartmentInfo T009
			ON 
				T007.customerNo=T009.customerNo
			AND
				T007.customerDepartmentCode=T009.customerDepartmentCode
	UNION
		SELECT 
			T007.customerNo,
			T007.customerName,
			T007.purchasingManagersMail,
			T007.purchasingManagers,
			T007.customerDepartment,
			T007.customerDepartmentCode,
			T007.positionCode,
			T009.responsiblePerson 
		FROM
			(SELECT 
				customerNo,
				customerName,
				purchasingManagersMail,
				purchasingManagers,
				"営業部" as customerDepartment,
				customerDepartmentCode,
				positionCode,
				representative as responsiblePerson 
			FROM 
				T007CustomerInfo
			WHERE
				purchasingManagers!="" 
			AND
				customerDepartmentCode=4)T007
			LEFT JOIN 
				T009CustomerDepartmentInfo T009 
			ON
				T007.customerNo=T009.customerNo 
			AND
				T007.customerDepartmentCode=T009.customerDepartmentCode
			GROUP BY
			 customerNo)as T007
    </select>
    <!--　担当取る -->
    <select id="getSalesPersons" parameterType="String" resultType="jp.co.lyc.cms.model.SendRepotModel">
		SELECT 
		    customerDepartmentCode,
		    positionCode,
		    responsiblePerson,
		    customerDepartmentMail
		FROM
		    T009CustomerDepartmentInfo
		WHERE
		    customerNo = #{customerNo};
	</select>
    <select id="getLists" resultType="jp.co.lyc.cms.model.SendRepotModel">
			select 
				StorageListName as name,transmissionClassificationCode as code,customerList as customerNo
			from 
				T021CustomerSendMailStorageList 
			where 
				transmissionClassificationCode=0 order by StorageListName
    </select>
    <select id="getCustomersByNos" resultType="jp.co.lyc.cms.model.SendRepotModel">
		SELECT 
		(@rowNo:=@rowNo+1 ) AS rowId,
	    T007.customerNo,
	    T007.customerName,
	    T007.purchasingManagers,
	    T009.customerDepartmentCode,
	    T009.positionCode,
	    T007.purchasingManagersMail,
	    T007.levelCode,
	    '' AS monthCount,
	    '' AS purchasingManagers2,
		'' AS positionCode2,
		'' AS purchasingManagersMail2
	FROM
	    T007CustomerInfo AS T007
	        LEFT JOIN
	    T009CustomerDepartmentInfo AS T009 ON T007.customerNo = T009.customerNo
	        AND T007.purchasingManagers = T009.responsiblePerson, (SELECT
			@rowNo:=0) AS rowId
			WHERE
	   T007.customerNo IN 
	     <foreach collection="array" index="index" item="item" open="(" separator="," close=")">
	         #{item}
	    </foreach>
    </select>
    <insert id="creatList" parameterType="String">
  		INSERT INTO T021CustomerSendMailStorageList
		(StorageListName,
		transmissionClassificationCode,
		customerList,
		updateTime,
		createTime,
		updateUser)
		VALUES
		(
		#{name},
		0,
		#{code},
		 NOW(),
		 NOW(),
		#{updateUser})
    </insert>
    <update id="listNameUpdate" parameterType="String">
		update
			T021CustomerSendMailStorageList
		set
			StorageListName=#{storageListName},updateTime=now(),updateUser=#{updateUser}
		where 
			StorageListName=#{oldStorageListName} and transmissionClassificationCode=0
	</update>
	
   	<delete id="deleteList" parameterType="String">
		DELETE
		FROM
			T021CustomerSendMailStorageList
		WHERE
			StorageListName=#{storageListName} and transmissionClassificationCode=0;
	</delete>
	 <update id="deleteListOfEmp" parameterType="String">
		update
			T018WorkTotalTime
		set
			StorageListName="",updateTime=now(),updateUser=#{updateUser}
		where 
			StorageListName=#{storageListName};
	</update>
</mapper>