<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="jp.co.lyc.cms.mapper.CustomerInfoMapper">
    <resultMap id="SelectCustomerInfo" type="map"/>
    <resultMap id="customerNoSaiBan" type="java.lang.String"/>
    <resultMap id="topCustomer" type="jp.co.lyc.cms.model.TopCustomerInfoModel"/>
    <resultMap id="CustomerDepartmentMaster" type="jp.co.lyc.cms.model.CustomerDepartmentInfoModel"/>
    <resultMap id="CustomerInfo" type="jp.co.lyc.cms.model.CustomerInfoModel"/>
    <resultMap id="CustomerDepartmentInfo" type="jp.co.lyc.cms.model.CustomerDepartmentInfoModel"/>
    <!-- お客様ランキング選択肢 -->
    <select id="selectCustomerRanking" resultMap="SelectCustomerInfo">
        SELECT 
			customerRankingCode,
        	customerRankingName
        FROM 
        	M008CustomerRanking
    </select>
    <!-- 会社性質選択肢 -->
    <select id="selectCompanyNature" resultMap="SelectCustomerInfo">
        SELECT 
			companyNatureCode,
        	companyNatureName
        FROM 
        	M007CompanyNature
    </select>
    <!-- 職位選択肢 -->
    <select id="selectPosition" resultMap="SelectCustomerInfo">
        SELECT 
			positionCode,
        	positionName
        FROM 
        	M019Position
    </select>
    <!-- お客様番号採番 -->
    <select id="customerNoSaiBan" resultMap="customerNoSaiBan">
        SELECT 
        	MAX(customerNo) AS saibanCustomerNo
        FROM 
        	customer_information
    </select>
    <!-- 上位お客様連想 -->
    <select id="selectTopCustomer" resultMap="topCustomer" parameterType="String">
        SELECT 
        	topCustomerName
        FROM 
        	top_customer
        WHERE
        	topCustomerName LIKE concat('%',#{topCustpmerName},'%')
    </select>
    <!-- 上位お客様存在チェック -->
    <select id="checkTopCustomer" resultMap="customerNoSaiBan" parameterType="String">
        SELECT 
        	topCustomerNo
        FROM 
        	top_customer
        WHERE
        	topCustomerName = #{topCustomerName}
    </select>
    <!-- お客様情報検索 -->
    <select id="selectCustomerInfo" resultMap="CustomerInfo" parameterType="String">
		SELECT
			ci.*,
			tc.topCustomerName 
		FROM
			customer_information AS ci
			LEFT JOIN top_customer AS tc ON ci.topCustomerNo = tc.topCustomerNo 
		WHERE
			customerNo = #{customerNo}
    </select>
    <!-- お客様情報インサート -->
    <insert id="insertCustomerInfo" parameterType="String">
		INSERT INTO customer_information 
		VALUE(
		#{customerNo},
		#{customerName},
		#{customerAbbreviation},
		#{headOffice},
		#{businessStartDate},
		#{topCustomerNo},
		#{establishmentDate},
		#{customerRankingCode},
		#{listedCompany},
		#{companyNatureCode},
		#{url},
		#{PurchasingManagers},
		#{remark},
		#{PurchasingManagersOfmail},
		NOW(),
		NOW(),
		#{updateUser})
    </insert>
    <!-- お客様情報アップデート -->
    <update id="updateCustomerInfo" parameterType="String">
		UPDATE customer_information
		SET 
		<if test="customerName != null">
			customerName = #{customerName},
		</if>
		<if test="customerAbbreviation != null">
			customerAbbreviation = #{customerAbbreviation},
		</if>
		<if test="headOffice != null">
			headOffice = #{headOffice},
		</if>
		<if test="businessStartDate != null">
			businessStartDate = #{businessStartDate},
		</if>
		<if test="topCustomerNo != null">
			topCustomerNo = #{topCustomerNo},
		</if>
		<if test="establishmentDate != null">
			establishmentDate = #{establishmentDate},
		</if>
		<if test="customerRankingCode != null">
			customerRankingCode = #{customerRankingCode},
		</if>	
		<if test="listedCompany != null">
			listedCompany = #{listedCompany},
		</if>	
		<if test="url != null">
			url = #{url},
		</if>	
		<if test="PurchasingManagers != null">
			PurchasingManagers = #{PurchasingManagers},
		</if>
		<if test="PurchasingManagersOfmail != null">
			PurchasingManagersOfmail = #{PurchasingManagersOfmail},
		</if>
		<if test="remark != null">
			remark = #{remark},
		</if>			
		updateTime = NOW(),
		updateUser = #{updateUser}
		WHERE 
			customerNo = #{customerNo}
		AND customerDepartmentCode = #{customerDepartmentCode}
    </update> 
    <!-- 部門検索 -->  
    <select id="selectCustomerDepartmentInfo" resultMap="CustomerDepartmentInfo" parameterType="map">
		SELECT
			CONCAT(( @rowNo := @rowNo + 1 )) AS rowNo,
			customerDepartmentName,
			position,
			responsiblePerson,
			mail 
		FROM
			M018CustomerDepartment,
			( SELECT @rowNo := 0 ) AS rowNo 
		WHERE
			customerNo = #{customerNo}
			<if test="customerDepartmentCode != NULL">
			AND customerDepartmentCode = #{customerDepartmentCode}
			</if>
    </select>
    <!-- 部門名前連想 -->
    <select id="selectDepartmentMaster" resultMap="CustomerDepartmentMaster" parameterType="String">
		SELECT
			customerDepartmentName
		FROM
			customer_department_master 
		WHERE
			customerDepartmentName LIKE concat('%',#{customerDepartmentName},'%')
    </select>
    <!-- 部門コード存在チェック -->
    <select id="selectDepartmentCode" resultMap="customerNoSaiBan" parameterType="String">
		SELECT
			customerDepartmentCode
		FROM
			customer_department_master 
		WHERE
			customerDepartmentName = #{customerDepartmentName}
    </select>
    <!-- 部門情報インサート -->
    <insert id="insertCustomerDepartment" parameterType="String">
		INSERT INTO M018CustomerDepartment 
		VALUE(
		#{customerNo},
		#{customerDepartmentCode},
		#{customerDepartmentName},
		#{position},
		#{responsiblePerson},
		#{mail},
		NOW(),
		NOW(),
		#{updateUser})
    </insert>
    <!-- 部門情報アップデート -->
    <update id="updateCustomerDepartment" parameterType="String">
		UPDATE M018CustomerDepartment
		SET 
		<if test="customerDepartmentCode != null">
			customerDepartmentCode = #{customerDepartmentCode},
		</if>
		<if test="customerDepartmentName != null">
			customerDepartmentName = #{customerDepartmentName},
		</if>
		<if test="position != null">
			position = #{position},
		</if>
		<if test="responsiblePerson != null">
			responsiblePerson = #{responsiblePerson},
		</if>
		<if test="mail != null">
			mail = #{mail},
		</if>			
		updateTime = NOW(),
		updateUser = #{updateUser}
		WHERE 
			customerNo = #{customerNo}
    </update>
</mapper>