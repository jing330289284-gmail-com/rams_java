<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="jp.co.lyc.cms.mapper.SiteSearchMapper">
	<select id="getSiteInfo" parameterType="map"
		resultType="jp.co.lyc.cms.model.SiteSearchModel">
		SELECT
		dataTab.employeeNo,
		dataTab.systemName,
		dataTab.unitPrice,
		dataTab.admissionStartDate,
		dataTab.admissionEndDate,
		dataTab.siteRoleName,
		dataTab.customerName,
		dataTab.employeeNo,
		dataTab.employeeName,
		dataTab.developLanguageName,
		dataTab.station,
		dataTab.bpBelongCustomerCode,
		dataTab.employeeFrom
		FROM
		(
		SELECT
		a.employeeNo,
		a.systemName,
		a.unitPrice,
		a.admissionStartDate,
		a.admissionEndDate,
		b.siteRoleName,

		if(c.customerAbbreviation is null or
		trim(c.customerAbbreviation)='',c.customerName,c.customerAbbreviation)
		as customerName,

		CONCAT(g.employeeFristName,g.employeeLastName)as
		employeeName ,

		e.developLanguageName,
		f.stationName as station,
		h.bpBelongCustomerCode,

		(
		SELECT
		IF
		( customerAbbreviation IS NULL OR trim( customerAbbreviation ) = '',
		customerName, customerAbbreviation )
		FROM
		T007CustomerInfo AS T007
		left join T011BpInfoSupplement AS T011 on
		T007.customerNo = T011.bpBelongCustomerCode
		WHERE
		T011.bpEmployeeNo = a.employeeNo
		) AS employeeFrom

		FROM
		T006EmployeeSiteInfo a
		LEFT JOIN
		M012SiteRole
		b ON
		a.siteRoleCode = b.siteRoleCode
		LEFT JOIN
		T007CustomerInfo c ON
		a.customerNo = c.customerNo
		LEFT JOIN
		T002EmployeeDetail d ON
		a.employeeNo = d.employeeNo
		LEFT JOIN
		M011DevelopLanguage e ON
		a.developLanguageCode =
		e.developLanguageCode
		LEFT JOIN
		M013Station
		f ON
		a.stationCode =
		f.stationCode
		LEFT JOIN
		T001Employee g ON
		a.employeeNo =
		g.employeeNo
		LEFT JOIN
		T011BpInfoSupplement h ON
		a.employeeNo =
		h.bpEmployeeNo
		WHERE
		1=1
		<if test="employeeNo!= null and employeeNo!= ''">
			AND a.employeeNo = #{employeeNo}
		</if>
		<if test="stationCode!= null and stationCode!= ''">
			AND a.stationCode = #{stationCode}
		</if>
		<if test="siteRoleCode!= null and siteRoleCode!= ''">
			AND a.siteRoleCode = #{siteRoleCode}
		</if>
		<if test="customerNo!= null and customerNo!= ''">
			AND a.customerNo = #{customerNo}
		</if>
		<if test="topCustomerNo!= null and topCustomerNo!= ''">
			AND a.topCustomerNo = #{topCustomerNo}
		</if>
		<if test="bpCustomerNo!= null and bpCustomerNo!= ''">
			AND h.bpBelongCustomerCode = #{bpCustomerNo}
		</if>
		<if test="typeOfIndustryCode!= null and typeOfIndustryCode!= ''">
			AND a.typeOfIndustryCode = #{typeOfIndustryCode}
		</if>
		<if test="payOffRange1!= null and payOffRange1!= ''">
			<if test="payOffRange1 =='0'.toString()">
				AND a.payOffRange1 = #{payOffRange1}
			</if>
			<if test="payOffRange1 !='0'">
				AND a.payOffRange1 &gt;= #{payOffRange1}
			</if>
		</if>
		<if test="payOffRange2!= null and payOffRange2!= ''">
			<if test="payOffRange2 =='0'.toString()">
				AND a.payOffRange2 = #{payOffRange2}
			</if>
			<if test="payOffRange2 !='0'">
				AND a.payOffRange2 &lt;= #{payOffRange2}
			</if>
		</if>
		<if test="unitPrice1!= null and unitPrice1!= ''">
			AND cast(a.unitPrice as signed) &gt;= cast(#{unitPrice1} as signed) 
		</if>
		<if test="unitPrice2!= null and unitPrice2!= ''">
			AND cast(a.unitPrice as signed) &lt;= cast(#{unitPrice2} as signed)
		</if>
		<if test="developLanguageCode!= null and developLanguageCode!= ''">
			AND a.developLanguageCode = #{developLanguageCode}
		</if>
		<if
			test="admissionStartDate!= null and admissionStartDate!= ''
			and dataAcquisitionPeriod== null or dataAcquisitionPeriod== ''">
			AND a.admissionStartDate &gt;= #{admissionStartDate}
		</if>
		<if test="admissionEndDate!= null and admissionEndDate!= ''">
			AND a.admissionEndDate &lt;= #{admissionEndDate}
		</if>
		<if
			test="dataAcquisitionPeriod!= null and dataAcquisitionPeriod!= ''">
			AND a.admissionEndDate IS NULL
		</if>
		<if test="employeeStatus!= null and employeeStatus!= ''">
			AND d.employeeStatus = #{employeeStatus}
		</if>
		<if test="employeeForm!= null and employeeForm!= ''">
			<if test='employeeForm=="0"'>
				AND d.employeeFormCode !='3'
			</if>
			<if test='employeeForm=="1"'>
				AND d.employeeFormCode = '3'
			</if>
		</if>
		<if test="scheduledEndDate != null and scheduledEndDate!= ''">
			AND a.scheduledEndDate &lt;= #{scheduledEndDate}
		</if>
		ORDER BY
		a.employeeNo,
		a.admissionStartDate DESC
		)AS dataTab
		GROUP BY dataTab.employeeNo
	</select>

</mapper>